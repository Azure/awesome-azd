#!/usr/bin/env node

/**
 * Creates pull requests for each discovered azd extension.
 * Reads discovered-extensions.json (output of discover-extensions.js),
 * then creates a branch + PR per extension via the GitHub API.
 *
 * Called from actions/github-script; receives { github, context }.
 *
 * Usage (in workflow):
 *   script: |
 *     const script = require('./.github/scripts/create-extension-prs.js');
 *     await script({ github, context });
 */

const fs = require("fs");
const path = require("path");
const { sanitizeBranchName, escapeMarkdown } = require("./github-utils");

module.exports = async ({ github, context }) => {
  const discoveredPath = path.join(
    process.cwd(),
    "discovered-extensions.json",
  );
  if (!fs.existsSync(discoveredPath)) {
    console.log("No discovered extensions file found");
    return;
  }

  let discovered;
  try {
    discovered = JSON.parse(fs.readFileSync(discoveredPath, "utf-8"));
  } catch (err) {
    console.error(`Failed to parse discovered-extensions.json: ${err.message}`);
    return;
  }

  if (!Array.isArray(discovered) || discovered.length === 0) {
    console.log("No new extensions discovered");
    return;
  }

  console.log(`Creating PRs for ${discovered.length} discovered extensions`);

  const extensionsPath = path.join(
    process.cwd(),
    "website",
    "static",
    "extensions.json",
  );

  let baseExtensions;
  try {
    baseExtensions = JSON.parse(fs.readFileSync(extensionsPath, "utf-8"));
  } catch (err) {
    console.error(`Failed to parse extensions.json: ${err.message}`);
    return;
  }

  for (const item of discovered) {
    const { repoFullName, repoUrl, extensionId, entry } = item;
    const safeName = sanitizeBranchName(extensionId);
    const branchName = `discover/extension-${safeName}`.substring(0, 60);

    try {
      // Get the default branch SHA
      const { data: ref } = await github.rest.git.getRef({
        owner: context.repo.owner,
        repo: context.repo.repo,
        ref: "heads/main",
      });

      // Create branch
      try {
        await github.rest.git.createRef({
          owner: context.repo.owner,
          repo: context.repo.repo,
          ref: `refs/heads/${branchName}`,
          sha: ref.object.sha,
        });
      } catch (err) {
        if (err.status === 422) {
          console.log(`Branch ${branchName} already exists, skipping`);
          continue;
        }
        throw err;
      }

      // Add the new extension entry
      const updatedExtensions = [...baseExtensions, entry];

      // Get the current file to find its SHA
      const { data: fileData } = await github.rest.repos.getContent({
        owner: context.repo.owner,
        repo: context.repo.repo,
        path: "website/static/extensions.json",
        ref: branchName,
      });

      // Update the file on the branch
      await github.rest.repos.createOrUpdateFileContents({
        owner: context.repo.owner,
        repo: context.repo.repo,
        path: "website/static/extensions.json",
        message: `feat: add discovered extension - ${extensionId}`,
        content: Buffer.from(
          JSON.stringify(updatedExtensions, null, 2) + "\n",
        ).toString("base64"),
        sha: fileData.sha,
        branch: branchName,
      });

      const capabilities = entry.capabilities || [];
      const platforms = entry.platforms || [];

      // Escape external content to prevent markdown table breakage
      // and formatting injection from untrusted repo data
      const safeDisplayName = escapeMarkdown(entry.displayName);
      const safeDescription = escapeMarkdown(entry.description);

      // Create PR
      await github.rest.pulls.create({
        owner: context.repo.owner,
        repo: context.repo.repo,
        title: `feat: add discovered extension - ${extensionId}`,
        head: branchName,
        base: "main",
        body: `## üîç Auto-Discovered Extension

This PR was automatically generated by the extension discovery workflow.

### Extension Details

| Field | Value |
|-------|-------|
| **Repository** | [${repoFullName}](${repoUrl}) |
| **Extension ID** | \`${extensionId}\` |
| **Display Name** | ${safeDisplayName} |
| **Description** | ${safeDescription} |
| **Author** | ${escapeMarkdown(entry.author)} |
| **Version** | ${entry.latestVersion} |
| **Capabilities** | ${capabilities.join(", ")} |
| **Platforms** | ${platforms.join(", ")} |
| **Install** | \`${entry.installCommand}\` |

### Registry URL
\`${entry.registryUrl}\`

### How This Was Discovered

\`\`\`mermaid
flowchart TD
    A[‚è∞ Daily Cron] --> B[Search GitHub API]
    B --> |"filename:registry.json"| C[Raw Results]
    C --> D{Filter}
    D --> |Fork/Archived/Duplicate?| X1[‚ùå Skip]
    D --> |In ignore list?| X2[‚ùå Skip]
    D --> |Pass filters| E[Fetch registry.json]
    E --> F[üîç validate-extension.js]
    F --> G{Valid?}
    G --> |No| X3[‚ùå Skip]
    G --> |Yes| H[Extract Metadata]
    H --> I[üìã This PR]
    I --> J{üë§ Team Review}
    J --> |‚úÖ Merge| K[Added to Gallery]
    J --> |‚ùå Close| L[Add to ignore list]

    style I fill:#0078d4,stroke:#005a9e,color:#fff
\`\`\`

### üë§ Review Checklist

- [ ] Extension ID and display name are appropriate
- [ ] Registry.json is valid and accessible
- [ ] Extension is production-ready (not a test or demo)
- [ ] Capabilities are correctly detected
- [ ] Author information is accurate

### ‚ö†Ô∏è If Closing This PR

Please add the repo to \`.github/discovery-ignore.json\` with a justification:
\`\`\`json
{
  "source": "${repoUrl}",
  "reason": "<your reason here>",
  "addedBy": "<your-github-username>",
  "addedDate": "${new Date().toISOString().split("T")[0]}"
}
\`\`\`
`,
        labels: ["extension-discovery", "automated"],
      });

      console.log(`‚úì Created PR for ${extensionId}`);
    } catch (err) {
      console.error(
        `‚úó Failed to create PR for ${extensionId}: ${err.message}`,
      );
    }
  }
};
